<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Ficha de Manipula√ß√£o</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .anexos {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .anexos img {
            width: 48%;
            max-height: 250px;
            object-fit: contain;
            border: 1px solid #ccc;
            padding: 5px;
            background: #fff;
        }
        body { font-family: Arial, sans-serif; padding: 20px; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .header img { max-height: 60px; }
        h1, h2 { margin: 0; padding: 0; }
        h1 { font-size: 24px; font-weight: bold; }
        h2 { font-size: 18px; }
        hr { border: 1px solid black; margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        table, th, td { border: 1px solid black; }
        th, td { padding: 8px; text-align: left; }
        .signature-line { margin-top: 50px; text-align: center; font-size: 14px; }
        .signature-line span { display: inline-block; margin-top: 10px; border-top: 1px solid black; width: 400px; }
        .anexos img { max-width: 100%; max-height: 300px; margin: 10px auto; display: block; }
    </style>
</head>
<body>

<div id="conteudo-pdf">Carregando ficha de manipula√ß√£o...</div>

<script>
    const localData = JSON.parse(localStorage.getItem('fichaPdfData'));
    if (!localData || !localData.documento || !localData.system_unit_id) {
        document.body.innerHTML = "<p>Erro: Dados locais da ficha ausentes.</p>";
        throw new Error('Dados da ficha ausentes.');
    }

    const baseUrl = location.hostname === 'localhost'
        ? 'http://localhost/portal-deck/api/v1/index.php'
        : 'https://portal.vemprodeck.com.br/api/v1/index.php';

    async function getBase64ImageFromURL(url) {
        const response = await fetch(url);
        const blob = await response.blob();
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });
    }

    async function gerarFicha(data, logoBase64) {
        const { cabecalho, itens, anexos } = data;
        const produto = `${cabecalho.codigo_produto} - ${cabecalho.nome_produto ?? '(produto)'}`;

        // Converte todas as imagens para base64
        const anexosBase64 = await Promise.all(
            anexos.map(async (a) => await getBase64ImageFromURL(a.url))
        );

        const html = `
      <div class="header">
        <div>
          <h1>Portal Deck</h1>
          <h2>Ficha de Manipula√ß√£o</h2>
        </div>
        <div>
          <img src="${logoBase64}" alt="Logo">
        </div>
      </div>
      <hr>
      <p><strong>Unidade:</strong> ${cabecalho.nome_unidade}</p>
      <p><strong>Operador:</strong> ${cabecalho.nome_operador}</p>
      <p><strong>Data:</strong> ${cabecalho.data}</p>
      <p><strong>Documento:</strong> ${cabecalho.documento}</p>
      <p><strong>Produto:</strong> ${produto}</p>
      <p><strong>Peso Bruto:</strong> ${parseFloat(cabecalho.peso_bruto).toFixed(3)} kg</p>
      <p><strong>Descarte:</strong> ${parseFloat(cabecalho.descarte).toFixed(3)} kg (${cabecalho.percentual_descarte}%)</p>
      <p><strong>Aproveitamento:</strong> ${cabecalho.percentual_aproveitamento}%</p>
      <hr>

      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Insumo</th>
            <th>Quantidade</th>
            <th>Unidade</th>
            <th>%</th>
          </tr>
        </thead>
        <tbody>
          ${itens.map((item, i) => `
            <tr>
              <td>${i + 1}</td>
              <td>${item.codigo_insumo} - ${item.nome_produto}</td>
              <td>${item.quantidade}</td>
              <td>${item.unidade}</td>
              <td>${item.percentual_item}%</td>
            </tr>
          `).join('')}
        </tbody>
      </table>

      <hr>
    <h2>Anexos</h2>
    <div class="anexos-grid" style="display: flex; flex-wrap: wrap; gap: 10px;">
      ${anexosBase64.map(base64 => `
        <div style="
          width: calc(50% - 10px);
          page-break-inside: avoid;
          padding: 5px;
        ">
          <img src="${base64}" style="
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border: 1px solid #ccc;
            display: block;
            margin: 0 auto;
          " />
        </div>
      `).join('')}
    </div>



      <div class="signature-line">
        <span>Assinatura do Respons√°vel</span>
      </div>
    `;

        const container = document.getElementById('conteudo-pdf');
        container.innerHTML = html;

        await new Promise(resolve => setTimeout(resolve, 500)); // Aguarda renderizar

        const arrayBuffer = await html2pdf()
            .from(container)
            .set({
                margin: 10,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            })
            .toPdf()
            .output('arraybuffer');

        return new File([arrayBuffer], `ficha_${cabecalho.documento}.pdf`, { type: 'application/pdf' });
    }


    async function iniciarFicha() {
        try {
            const logoBase64 = await getBase64ImageFromURL('deck.png');

            const response = await axios.post(baseUrl, {
                method: 'getDetalhesMovimentacao',
                data: {
                    documento: localData.documento,
                    system_unit_id: localData.system_unit_id
                }
            });

            if (!response.data.success || !response.data.data) {
                throw new Error('Erro ao buscar dados da ficha.');
            }

            const file = await gerarFicha(response.data.data, logoBase64);

            Swal.fire({
                title: 'O que deseja fazer?',
                text: 'Escolha uma a√ß√£o para o PDF gerado:',
                icon: 'question',
                showDenyButton: true,
                confirmButtonText: 'üì• Baixar PDF',
                denyButtonText: 'üîó Compartilhar PDF'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const url = URL.createObjectURL(file);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.name;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                } else if (result.isDenied) {
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            title: `Ficha ${localData.documento}`,
                            text: 'Segue a ficha de manipula√ß√£o.',
                            files: [file]
                        });
                    } else {
                        alert('Seu navegador n√£o suporta compartilhamento de arquivos.');
                    }
                }
            });
        } catch (err) {
            console.error(err);
            Swal.fire('Erro', 'Falha ao carregar a ficha de manipula√ß√£o.', 'error');
        }
    }

    setTimeout(iniciarFicha, 300);
</script>

</body>
</html>
